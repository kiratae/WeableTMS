@using cntr = Weable.TMS.Web.Controllers.HomeController
@using System.Web
@model Weable.TMS.Web.Models.ListTrainingModel

@{
    ViewData["Title"] = "Home Page";
}

<style>
    .break-word {
        word-wrap: break-word;
    }
</style>

@{ TrainingModel nearest = new TrainingModel(); }
@if (Model.Trainings.Where(x => x.TrnStartDate > DateTime.Now).OrderBy(i => i.TrnStartDate).Count() > 0)
{
    nearest = Model.Trainings.Where(x => x.TrnStartDate > DateTime.Now).OrderBy(i => i.TrnStartDate).First();
    <div class="pt-5" style="background: linear-gradient(#13A4C9 95%, #eaecf4 5%)">

        <div class="pb-0 mb-0 container">

            <div class="row mb-3 mb-md-5">
                <div class="col-12 text-white">
                    <h3><span class="border-bottom-light">กิจกรรมที่กำลังจะเกิดขึ้น</span></h3>
                </div>
            </div>

            <div class="row no-gutters">
                <div class="col-md-6 col-12 text-white mb-3 order-md-0 order-1">
                    <h1 class="pb-3 break-word">@nearest.Name</h1>
                    <div class="row pt-1" id="clockdiv">
                        <div class="col-2 text-center">
                            <small>วัน</small>
                            <h1 class="days">0</h1>
                        </div>
                        <div class="col-1"><small>&ensp;</small><h1>:</h1></div>
                        <div class="col-2 text-center">
                            <small>ชั่วโมง</small>
                            <h1 class="hours">00</h1>
                        </div>
                        <div class="col-1"><small>&ensp;</small><h1>:</h1></div>
                        <div class="col-2 text-center">
                            <small>นาที</small>
                            <h1 class="minutes">00</h1>
                        </div>
                        <div class="col-1"><small>&ensp;</small><h1>:</h1></div>
                        <div class="col-2 text-center">
                            <small>วินาที</small>
                            <h1 class="seconds">00</h1>
                        </div>
                    </div>
                    <a class="btn btn-warning mt-3" href="@Url.Action(cntr.ActionDetail, cntr.Name, new { Id = nearest.TrainingId, ReturnUrl = HttpUtility.UrlPathEncode(Html.ViewContext.HttpContext.Request.Path) })">ข้อมูลเพิ่มเติม</a>
                </div>

                <div class="col-md-6 col-12 order-md-1 order-0 mb-3 mb-md-0 text-center">
                    <img class="shadow" src="~/images/test.jpg" style="width:100%; height: 350px;object-fit: cover;" />
                </div>
            </div>

        </div>
    </div>
}

<div class="bg-gray-200 pb-5 pt-3">
    <div class="container">

        @{ List<TrainingModel> recommends = new List<TrainingModel>(); }
        @if (Model.Trainings.Where(x => x.TrnStartDate > DateTime.Now && x.IsRecommend).Count() > 0)
        {
            recommends = Model.Trainings.Where(x => x.TrnStartDate > DateTime.Now && x.IsRecommend == true).OrderBy(i => i.TrnStartDate).Take(3).ToList();
        }
        <div class="row ">
            <div class="col-12 col-md-6">

                <h4>โครงการฝึกอบรมแนะนำ <i class="fa fa-star text-warning"></i></h4>
                <div id="carouselRecommands" class="carousel slide" data-ride="carousel">
                    <ol class="carousel-indicators">
                        @{ var index = 0; }
                        @foreach (var recommend in recommends)
                        {
                            if (index == 0)
                            {
                                <li data-target="#carouselRecommands" data-slide-to="@index" class="active"></li>
                            }
                            else
                            {
                                <li data-target="#carouselRecommands" data-slide-to="@index"></li>
                            }
                            index++;
                        }
                    </ol>
                    <div class="carousel-inner">
                        @{ index = 0; }
                        @foreach (var recommend in recommends)
                        {
                            if (index == 0)
                            {
                                <div class="carousel-item active">
                                    <img src="~/images/banner1.svg" style="width:100%; height: 300px;object-fit: cover;" alt="1">
                                    <div class="carousel-caption d-none d-block shadow p-2 pb-3" style="background: rgba(0,0,0,0.3)">
                                        <h5 class="break-word">@recommend.Name</h5>
                                        <a class="btn btn-warning mt-3" href="@Url.Action(cntr.ActionDetail, cntr.Name, new { Id = recommend.TrainingId, ReturnUrl = HttpUtility.UrlPathEncode(Html.ViewContext.HttpContext.Request.Path) })">ข้อมูลเพิ่มเติม</a>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="carousel-item">
                                    <img src="~/images/banner1.svg" style="width:100%; height: 300px;object-fit: cover;" alt="3">
                                    <div class="carousel-caption d-none d-block shadow p-2 pb-3" style="background: rgba(0,0,0,0.3)">
                                        <h5 class="break-word">@recommend.Name</h5>
                                        <a class="btn btn-warning mt-3" href="@Url.Action(cntr.ActionDetail, cntr.Name, new { Id = recommend.TrainingId, ReturnUrl = HttpUtility.UrlPathEncode(Html.ViewContext.HttpContext.Request.Path) })">ข้อมูลเพิ่มเติม</a>
                                    </div>
                                </div>
                            }
                            index++;
                        }
                    </div>
                    <a class="carousel-control-prev" href="#carouselRecommands" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carouselRecommands" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>

            </div>

            <div class="col-12 col-md-6 pt-5">
                <form action="/" method="post">
                    <h4 class="text-center pb-3">ค้นหาโครงการฝึกอบรมที่คุณสนใจ</h4>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="ชื่อโครงการ">
                        <div class="input-group-append">
                            <span class="input-group-text bg-white"><i class="fa fa-search"></i></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <select class="form-control">
                            <option value="value">- โครงการหลัก -</option>
                        </select>
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-6 col-12">
                            <select class="form-control">
                                <option value="value">- สถานะโครงการ -</option>
                            </select>
                        </div>
                        <div class="col-sm-6 col-12">
                            <select class="form-control">
                                <option value="value">2562</option>
                            </select>
                        </div>
                    </div>
                    <div class="pt-3">
                        <button type="submit" class="btn btn-primary btn-lg btn-block">ค้นหาข้อมูล</button>
                    </div>
                </form>

            </div>
        </div>

    </div>
</div>

<div class="container mb-5">
    <div class="mt-3">

        <a class="text-decoration-none" data-toggle="collapse" href="#collapse_rec" role="button" aria-expanded="false" aria-controls="collapse_rec">
            <div class="card card-body bg-primary text-white shadow mb-2">
                <div class="row align-items-center">
                    <div class="col-md-10 col-8 row">
                        <div class="col-md-8 col-12 text-truncate text-left">
                            <span><i class="fa fa-star text-warning"></i>&ensp;โครงการฝึกอบรมแนะนำ</span>
                        </div>
                        <div class="col-md-4 col-12 text-left text-md-center">
                            @{ var rec = Model.Trainings.Where(x => x.IsRecommend == true).Count(); }
                            <span>รวมทั้งหมด @rec โครงการ</span>
                        </div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div aria-label="tools" class="float-right">
                            <i class="arrow fa" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
        <div class="collapse mb-5" id="collapse_rec">
            @foreach (var t in Model.Trainings.Where(x => x.IsRecommend == true))
            {
                <div class="row mb-1">
                    <div class="col-md-3 col-12 mb-3 mb-md-0">
                        <img src="~/images/banner1.svg" />
                    </div>
                    <div class="col-md-9 col-12 text-left">
                        @{
                            var closeText = "";
                            if (t.PublishAtdDate <= DateTime.Now)
                            {
                                closeText = "(ประกาศรายชื่อผู้มีสิทธิ์เข้าร่วมอบรม) ";
                            }
                        }
                        <p>@closeText @t.Name</p>
                        <div class="row">
                            <div class="col-6 col-md-3 mb-3">
                                <span>สถานที่:<br><strong>@t.Location</strong></span>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <span>
                                    วันที่จัดอบรม:<br>

                                    @if (t.TrnStartDateText == t.TrnEndDateText)
                                    {
                                        <strong> @t.TrnStartDateText</strong>
                                    }
                                    else
                                    {
                                        <strong>@t.TrnStartDateText - @t.TrnEndDateText</strong>
                                    }

                                </span>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <span>
                                    วันที่รับสมัคร:<br>
                                    @if (t.RegisterStartDateText == t.RegisterEndDateText)
                                    {
                                        <strong>@t.RegisterEndDateText</strong>
                                    }
                                    else
                                    {
                                        <strong>@t.RegisterStartDateText - @t.RegisterEndDateText</strong>
                                    }
                                </span>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <span>
                                    สถานะ:<br>
                                    @{
                                        string StatusName = "-";
                                        if (DateTime.Now.Date < t.RegisterStartDate)
                                        {
                                            StatusName = "รอเปิดรับสมัคร";
                                        }
                                        if (t.RegisterStartDate <= DateTime.Now.Date && t.RegisterEndDate >= DateTime.Now.Date)
                                        {
                                            if (t.AttendeeQty >= t.SeatQty)
                                            {
                                                StatusName = "มีผู้สมัครครบแล้ว";
                                            }
                                            else
                                            {
                                                StatusName = "กำลังเปิดรับสมัคร";
                                            }
                                        }
                                        if (t.RegisterEndDate < DateTime.Now.Date)
                                        {
                                            StatusName = "ปิดรับสมัคร";
                                        }
                                        if (t.TrnEndDate < DateTime.Now.Date)
                                        {
                                            StatusName = "จัดฝึกอบรมแล้ว";
                                        }

                                    }
                                    <strong>@StatusName</strong>
                                </span>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                @{
                                    var AvailableSeat = (t.SeatQty - t.AttendeeQty) < 0 ? 0 : t.SeatQty - t.AttendeeQty;
                                }
                                <span class="title"><strong>จำนวนที่ว่าง : @AvailableSeat</strong></span>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <span class="title"><strong>จำนวนที่รับสมัคร : @t.SeatQty</strong></span>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <a class="btn btn-warning" href="@Url.Action(cntr.ActionDetail, cntr.Name, new { Id = t.TrainingId, ReturnUrl = HttpUtility.UrlPathEncode(Html.ViewContext.HttpContext.Request.Path) })">รายระเอียดเพิ่มเติม</a>
                            </div>
                            <div class="col-6 col-md-3 mb-3">
                                <a href="#" class="btn btn-primary">ลงทะเบียน</a>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
            }
        </div>

        @foreach (var c in Model.Trainings.GroupBy(c => c.CourseId))
        {
            var sum = Model.Trainings.Where(x => x.CourseId == c.First().CourseId).Count();
            <a class="text-decoration-none" data-toggle="collapse" href="#collapse_@c.First().CourseId" role="button" aria-expanded="false" aria-controls="collapse_@c.First().CourseId">
                <div class="card card-body bg-primary text-white shadow mb-2">
                    <div class="row align-items-center">
                        <div class="col-md-10 col-8 row">
                            <div class="col-md-8 col-12 text-truncate text-left">
                                <span>@c.First().Course.Name</span>
                            </div>
                            <div class="col-md-4 col-12 text-left text-md-center">
                                <span>รวมทั้งหมด @sum โครงการ</span>
                            </div>
                        </div>
                        <div class="col-md-2 col-4">
                            <div aria-label="tools" class="float-right">
                                <i class="arrow fa" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
            <div class="collapse mb-5" id="collapse_@c.First().CourseId">
                @foreach (var t in c)
                {
                    <div class="row mb-1">
                        <div class="col-md-3 col-12 mb-3 mb-md-0">
                            <img src="~/images/banner1.svg" />
                        </div>
                        <div class="col-md-9 col-12 text-left">
                            @{
                                var closeText = "";
                                if (t.PublishAtdDate <= DateTime.Now)
                                {
                                    closeText = "(ประกาศรายชื่อผู้มีสิทธิ์เข้าร่วมอบรม) ";
                                }
                            }
                            <p>@closeText @t.Name</p>
                            <div class="row">
                                <div class="col-6 col-md-3 mb-3">
                                    <span>สถานที่:<br><strong>@t.Location</strong></span>
                                </div>
                                <div class="col-6 col-md-3 mb-3">
                                    <span>
                                        วันที่จัดอบรม:<br>

                                        @if (t.TrnStartDateText == t.TrnEndDateText)
                                        {
                                            <strong> @t.TrnStartDateText</strong>
                                        }
                                        else
                                        {
                                            <strong>@t.TrnStartDateText - @t.TrnEndDateText</strong>
                                        }

                                    </span>
                                </div>
                                <div class="col-6 col-md-3 mb-3">
                                    <span>
                                        วันที่รับสมัคร:<br>
                                        @if (t.RegisterStartDateText == t.RegisterEndDateText)
                                        {
                                            <strong>@t.RegisterEndDateText</strong>
                                        }
                                        else
                                        {
                                            <strong>@t.RegisterStartDateText - @t.RegisterEndDateText</strong>
                                        }
                                    </span>
                                </div>
                                <div class="col-6 col-md-3 mb-3">
                                    <span>
                                        สถานะ:<br>
                                        @{
                                            string StatusName = "-";
                                            if (DateTime.Now.Date < t.RegisterStartDate)
                                            {
                                                StatusName = "รอเปิดรับสมัคร";
                                            }
                                            if (t.RegisterStartDate <= DateTime.Now.Date && t.RegisterEndDate >= DateTime.Now.Date)
                                            {
                                                if (t.AttendeeQty >= t.SeatQty)
                                                {
                                                    StatusName = "มีผู้สมัครครบแล้ว";
                                                }
                                                else
                                                {
                                                    StatusName = "กำลังเปิดรับสมัคร";
                                                }
                                            }
                                            if (t.RegisterEndDate < DateTime.Now.Date)
                                            {
                                                StatusName = "ปิดรับสมัคร";
                                            }
                                            if (t.TrnEndDate < DateTime.Now.Date)
                                            {
                                                StatusName = "จัดฝึกอบรมแล้ว";
                                            }

                                        }
                                        <strong>@StatusName</strong>
                                    </span>
                                </div>
                                <div class="col-6 col-md-3 mb-3">
                                    @{
                                        var AvailableSeat = (t.SeatQty - t.AttendeeQty) < 0 ? 0 : t.SeatQty - t.AttendeeQty;
                                    }
                                    <span class="title"><strong>จำนวนที่ว่าง : @AvailableSeat</strong></span>
                                </div>
                                <div class="col-6 col-md-3 mb-3">
                                    <span class="title"><strong>จำนวนที่รับสมัคร : @t.SeatQty</strong></span>
                                </div>
                                <div class="col-6 col-md-3 mb-3">
                                    <a class="btn btn-warning" href="@Url.Action(cntr.ActionDetail, cntr.Name, new { Id = t.TrainingId, ReturnUrl = HttpUtility.UrlPathEncode(Html.ViewContext.HttpContext.Request.Path) })">รายระเอียดเพิ่มเติม</a>
                                </div>
                                <div class="col-6 col-md-3 mb-3">
                                    <a href="#" class="btn btn-primary">ลงทะเบียน</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function getTimeRemaining(endtime) {

			var t = Date.parse(endtime) - Date.parse(new Date());
			var seconds = Math.floor((t / 1000) % 60);
			var minutes = Math.floor((t / 1000 / 60) % 60);
			var hours = Math.floor((t / (1000 * 60 * 60)) % 24);
			var days = Math.floor(t / (1000 * 60 * 60 * 24));
            return {
                'total': t,
                'days': days,
                'hours': hours,
                'minutes': minutes,
                'seconds': seconds
            };
        }

        function initializeClock(id, endtime) {
            var clock = document.getElementById(id);
            var daysSpan = clock.querySelector('.days');
            var hoursSpan = clock.querySelector('.hours');
            var minutesSpan = clock.querySelector('.minutes');
            var secondsSpan = clock.querySelector('.seconds');

            function updateClock() {
                var t = getTimeRemaining(endtime);

                daysSpan.innerHTML = t.days;
                hoursSpan.innerHTML = ('0' + t.hours).slice(-2);
                minutesSpan.innerHTML = ('0' + t.minutes).slice(-2);
                secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);

                if (t.total <= 0) {
					clearInterval(timeinterval);
					daysSpan.innerHTML = ('0');
					hoursSpan.innerHTML = ('00');
					minutesSpan.innerHTML = ('00');
					secondsSpan.innerHTML = ('00');

                }
            }

            updateClock();
            var timeinterval = setInterval(updateClock, 1000);
        }

		//var deadline = new Date(Date.parse(new Date()) + 15 * 24 * 60 * 60 * 1000);
        var checkN = '@nearest.TrainingId.HasValue';
        //alert(checkN);
        if (checkN != 'False') {
            var nearestDate = '@nearest.TrnStartDate';
            console.log(nearestDate);
		    var spl1 = nearestDate.split(" ");
		    var spl2 = spl1[0].split("/");
		    var spl3 = spl1[1].split(":");

            var deadline = new Date(parseInt(spl2[2]) - 543, parseInt(spl2[1]) - 1, parseInt(spl2[0]), parseInt(spl3[0]), parseInt(spl3[1]), parseInt(spl3[2]), 00);
            console.log(deadline);
            initializeClock('clockdiv', deadline);
        }
    </script>
}